name: Issue on CI failure

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  create-issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            const { data } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            const failed = data.jobs.filter(job => job.conclusion === 'failure');
            let body = `CI workflow run [${run.data.head_branch}](${run.data.html_url}) failed.\n`;
            body += failed.map(j => `- Job **${j.name}** [logs](${j.html_url})`).join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI failed on ${run.data.head_branch}`,
              body,
            });

