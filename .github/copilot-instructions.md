# Copilot Code Generation Instructions

## ðŸ“‹ CRITICAL: PROJECT MANIFEST REFERENCE

**ALWAYS CONSULT FIRST**: `/PROJECT-MANIFEST.json`
- Complete system architecture and dependency mapping
- All current components, modules, and their relationships
- Maintenance entry points and validation systems
- Performance metrics and AI integration capabilities

```powershell
# Reference manifest before making changes
$manifest = Get-Content "./PROJECT-MANIFEST.json" | ConvertFrom-Json
$manifest.core.modules  # View all modules and dependencies
$manifest.maintenanceSystem  # View maintenance tools
```

## Code Generation Guidelines

- Always use concise, minimal diffs for code suggestions.
- When editing files, use `// ...existing code...` to indicate unchanged regions.
- For PowerShell, Python, and Markdown, start code blocks with a comment containing the filepath.
- Never repeat unchanged code; use comments to indicate context.
- Group changes by file and use clear headers.
- For new files, suggest a location under `/workspaces/opentofu-lab-automation/`.
- When generating tests, follow the project's Pester or pytest conventions.
- Use project-specific helpers and modules where available.
- For documentation, use Markdown formatting and keep instructions clear and actionable.
- Avoid including secrets, credentials, or sensitive data in any suggestion.

## Project-Specific Guidelines

### Module Locations (Updated 2025-06-13)
- **LabRunner Module**: `/pwsh/modules/LabRunner/` (moved from `pwsh/lab_utils/LabRunner`)
- **CodeFixer Module**: `/pwsh/modules/CodeFixer/` 
- **Always use module paths**: `Import-Module "/path/to/pwsh/modules/ModuleName"`

### CodeFixer Integration
- Use `Invoke-ImportAnalysis -AutoFix` to detect and fix import issues
- Use `Invoke-PowerShellLint` for enhanced linting with PSScriptAnalyzer auto-install
- Use `Invoke-ComprehensiveValidation` for full project validation
- CodeFixer automatically detects outdated lab_utils paths and suggests fixes

### Testing Best Practices
- All tests should import LabRunner from the new modules location
- Use TestHelpers.ps1 which handles module loading correctly
- InModuleScope tests should reference LabRunner module correctly

## Report Management & Documentation

### Report Creation (CRITICAL)
- **NEVER create summary .md files in the project root directory**
- **ALWAYS use the report utility**: `./scripts/utilities/new-report.ps1 -Type "{category}" -Title "{title}" -Template "{template}"`
- **Categories**: `test-analysis`, `workflow-analysis`, `project-status`
- **Templates**: `test`, `workflow`, `project`, `custom`
- **Naming**: Auto-generated as `YYYY-MM-DD-descriptive-name.md`

### Documentation Standards
- Update `/docs/reports/INDEX.md` for significant reports
- Reference major reports in main `CHANGELOG.md`
- Use standardized report templates (generated by utility)
- All reports go in `/docs/reports/{category}/` subdirectories

## Project Maintenance Automation

### ðŸš€ Unified Maintenance System (Priority: Use First)
- **Quick Health Check**: `./scripts/maintenance/infrastructure-health-check.ps1 -Mode "Quick"`
- **Full Maintenance**: `./scripts/maintenance/unified-maintenance.ps1 -Mode "All" -AutoFix -UpdateChangelog`
- **Issue Tracking**: `./scripts/maintenance/track-recurring-issues.ps1 -Mode "All"`
- **Emergency Fixes**: `./scripts/maintenance/fix-infrastructure-issues.ps1 -Fix "All"`

### When to Use Maintenance Scripts
1. **Before making changes**: Quick health check to see current state
2. **After making changes**: Full maintenance with auto-fixes
3. **When things break**: Emergency fixes and issue analysis
4. **Regular maintenance**: Weekly comprehensive cycles

### Auto-Detected Issue Categories
- Missing command mocks â†’ Auto-add to TestHelpers.ps1
- PowerShell syntax errors â†’ Run fix-test-syntax.ps1
- Import path issues â†’ Update to new module structure
- Test container problems â†’ Fix nested containers
- Environment dependencies â†’ Add skip conditions

### Required Validation After Changes
```powershell
# For module changes
Import-Module "/workspaces/opentofu-lab-automation/pwsh/modules/CodeFixer"
Invoke-ComprehensiveValidation
Invoke-ImportAnalysis -AutoFix

# For test changes
./run-comprehensive-tests.ps1

# For workflow changes  
./scripts/workflow-health-check.sh
```

### Automated Scripts Usage
- **PowerShell validation**: `./scripts/validation/validate-powershell-scripts.ps1`
- **Project validation**: `./run-final-validation.ps1`
- **Import fixes**: `Invoke-ImportAnalysis -AutoFix` (CodeFixer module)
- **Comprehensive linting**: `Invoke-PowerShellLint` (CodeFixer module)

## ðŸ”— Dependency Management & Auto-Tracking

### Automatic Dependency Mapping
The project manifest automatically tracks and updates:
- **Module Dependencies**: All PowerShell module relationships
- **Function Inventories**: Exported functions from each module
- **Performance Metrics**: Real-time capability measurements
- **File Structure**: Current project organization and counts

### Manifest Auto-Update Triggers
The manifest updates automatically when:
1. **Unified maintenance runs** (any mode with completed operations)
2. **Module files change** (through CodeFixer import analysis)
3. **Manual trigger**: `./scripts/utilities/update-project-manifest.ps1 -Force`

### Using Manifest Data for Code Generation
```powershell
# Get current function inventory before adding new functions
$manifest = Get-Content "./PROJECT-MANIFEST.json" | ConvertFrom-Json
$codeFixerFunctions = $manifest.core.modules.CodeFixer.keyFunctions
$labRunnerFunctions = $manifest.core.modules.LabRunner.keyFunctions

# Check performance constraints before generating heavy operations
$metrics = $manifest.metrics.performance
if ($metrics.healthCheckTime -match "< 1 minute") {
    # Optimize for speed
}
```

### Dependency Validation Commands
```powershell
# Validate all dependencies are met
Import-Module "/workspaces/opentofu-lab-automation/pwsh/modules/CodeFixer"
Invoke-ComprehensiveValidation

# Check for circular dependencies or missing modules
Invoke-ImportAnalysis -Path "." -Verbose
```