. (Join-Path $PSScriptRoot 'TestDriveCleanup.ps1')
. (Join-Path $PSScriptRoot 'helpers' 'TestHelpers.ps1')
$skipNpm = -not (Get-Command npm -ErrorAction SilentlyContinue)
Describe 'Node installation scripts' -Skip:($skipNpm) {
    InModuleScope LabRunner {
        BeforeAll {
            # Set up standard mocks for cross-platform testing
            Disable-InteractivePrompts
            New-StandardMocks -IncludeMocks @('LabDownload', 'WebRequest', 'System')

            $script:nodeScripts = @(
                '0201_Install-NodeCore.ps1'
                '0202_Install-NodeGlobalPackages.ps1'
                '0203_Install-npm.ps1'
            )
            $script:core   = Get-RunnerScriptPath $script:nodeScripts[0]
            $script:global = Get-RunnerScriptPath $script:nodeScripts[1]
            $script:npm    = Get-RunnerScriptPath $script:nodeScripts[2]
            $script:origTemp = (Get-CrossPlatformTempPath)
            $script:CrossPlatformTempPath = Join-Path ([System.IO.Path]::GetTempPath()) 'pester-temp'
            New-Item -ItemType Directory -Path (Get-CrossPlatformTempPath) -Force | Out-Null
            $script:config = [pscustomobject]@{}
            Mock Get-Command { @{ Name = $Name } } -ParameterFilter { $Name -in 'npm','node' }
            function node { param([Parameter(ValueFromRemainingArguments = $true)






][string[]]$Args) }
        }
        It 'resolves script paths from the tests directory' -TestCases $script:nodeScripts {
        param($scriptName)
        






$path = Get-RunnerScriptPath $scriptName
        Test-Path $path | Should -BeTrue
    }
        It 'uses Node_Dependencies.Node.InstallerUrl when installing Node' {
        $cfg = @{ Node_Dependencies = @{ InstallNode=$true; Node = @{ InstallerUrl = 'http://example.com/node.msi' } } }
        $core = Get-RunnerScriptPath '0201_Install-NodeCore.ps1'
        
        . $core

        # Additional mocks specific to this test
        Mock Start-Process {}
        Mock Remove-Item {}
        Mock Get-Command { @{Name='node'} } -ParameterFilter { $Name -eq 'node' }

        Install-NodeCore -Config $cfg
        Should -Invoke -CommandName Invoke-LabWebRequest -Times 1 -ParameterFilter { $Uri -eq 'http://example.com/node.msi' }
    }
        It 'does nothing when InstallNode is $false' {
        $cfg = @{ Node_Dependencies = @{ InstallNode = $false } }
        $core = Get-RunnerScriptPath '0201_Install-NodeCore.ps1'

        . $core

        # Additional mocks specific to this test
        Mock Start-Process {}
        Mock Remove-Item {}
        Mock Get-Command {}

        Install-NodeCore -Config $cfg
        Should -Invoke -CommandName Invoke-LabWebRequest -Times 0
        Should -Invoke -CommandName Start-Process -Times 0
        Should -Invoke -CommandName Remove-Item -Times 0
    }
        It 'installs packages listed under GlobalPackages' {
        $cfg = @{ Node_Dependencies = @{ GlobalPackages = @('yarn','nodemon') } }
        $global = Get-RunnerScriptPath '0202_Install-NodeGlobalPackages.ps1'
        Mock Get-Command { @{Name='npm'} } -ParameterFilter { $Name -eq 'npm' }
        function Invoke-LabNpm {
            param([Parameter(ValueFromRemainingArguments = $true)






][string[]]$testArgs)
            $null = $testArgs
        }
        . $global
        Mock Invoke-LabNpm -ModuleName LabRunner {}
        $WhatIfPreference = $false
        Install-NodeGlobalPackages -Config $cfg
        Should -Invoke -CommandName Invoke-LabNpm -Times 1 -ParameterFilter { ($testArgs -join ' ') -eq 'install -g yarn' }
        Should -Invoke -CommandName Invoke-LabNpm -Times 1 -ParameterFilter { ($testArgs -join ' ') -eq 'install -g nodemon' }
        Should -Invoke -CommandName Invoke-LabNpm -Times 0 -ParameterFilter { ($testArgs -join ' ') -eq 'install -g vite' }
    }
        It 'falls back to boolean flags when GlobalPackages is missing' {
        $cfg = @{ Node_Dependencies = @{ InstallYarn=$true; InstallVite=$false; InstallNodemon=$true } }
        $global = Get-RunnerScriptPath '0202_Install-NodeGlobalPackages.ps1'
        Mock Get-Command { @{Name='npm'} } -ParameterFilter { $Name -eq 'npm' }
        function Invoke-LabNpm {
            param([Parameter(ValueFromRemainingArguments = $true)






][string[]]$testArgs)
            $null = $testArgs
        }
        . $global
        Mock Invoke-LabNpm -ModuleName LabRunner {}
        $WhatIfPreference = $false
        Install-NodeGlobalPackages -Config $cfg
        Should -Invoke -CommandName Invoke-LabNpm -Times 1 -ParameterFilter { ($testArgs -join ' ') -eq 'install -g yarn' }
        Should -Invoke -CommandName Invoke-LabNpm -Times 1 -ParameterFilter { ($testArgs -join ' ') -eq 'install -g nodemon' }
        Should -Invoke -CommandName Invoke-LabNpm -Times 0 -ParameterFilter { ($testArgs -join ' ') -eq 'install -g vite' }
    }
        It 'logs start message when running each node script' -TestCases $script:nodeScripts {
        param($scriptName)

        






$path = Get-RunnerScriptPath $scriptName
        Mock-WriteLog
        . $path

        switch ($scriptName) {
            '0201_Install-NodeCore.ps1'            { Install-NodeCore -Config $script:config }
            '0202_Install-NodeGlobalPackages.ps1' { Install-NodeGlobalPackages -Config $script:config }
            '0203_Install-npm.ps1'                { Install-NpmDependencies -Config $script:config }
        }

        Should -Invoke -CommandName Write-CustomLog -Times 1 -ParameterFilter { $Message -eq "Running $scriptName" }
    }
        It 'honours -WhatIf for Install-GlobalPackage' {
    
        $global = Get-RunnerScriptPath '0202_Install-NodeGlobalPackages.ps1'

        function Invoke-LabNpm { param([Parameter(ValueFromRemainingArguments = $true)






][string[]]$testArgs) }

        Mock Invoke-LabNpm -ModuleName LabRunner {}

        . $global
        Mock Invoke-LabNpm -ModuleName LabRunner {}
        Install-NodeGlobalPackages -Config @{ Node_Dependencies = @{ InstallYarn=$false; InstallVite=$false; InstallNodemon=$false } } -WhatIf
        Should -Invoke -CommandName Invoke-LabNpm -Times 0
    }
        It 'uses NpmPath from Node_Dependencies when installing project deps' {
        $temp = Join-Path (Get-CrossPlatformTempPath) ([System.Guid]::NewGuid())
        New-Item -ItemType Directory -Path $temp | Out-Null
        New-Item -ItemType File -Path (Join-Path $temp 'package.json') | Out-Null
        $cfg = @{ Node_Dependencies = @{ NpmPath = $temp } }
        function Invoke-LabNpm {
            param([Parameter(ValueFromRemainingArguments = $true)






][string[]]$testArgs)
            $null = $testArgs
        }
        $npmPath = Get-RunnerScriptPath '0203_Install-npm.ps1'

        Mock Invoke-LabNpm -ModuleName LabRunner {}

        Mock Invoke-LabNpm -ModuleName LabRunner {}

        . $npmPath -Config $cfg
        Mock Invoke-LabNpm -ModuleName LabRunner {}

        # Dot-source the script with a minimal config object
        $config = [pscustomobject]@{}

        . $npmPath -Config $config

        Install-NpmDependencies -Config $cfg
        Should -Invoke -CommandName Invoke-LabNpm -Times 1 -ParameterFilter { $testArgs[0] -eq 'install' }
        Remove-Item -Recurse -Force $temp
    }

    AfterAll {
        Remove-Item Function:node -ErrorAction SilentlyContinue
        if ((Get-CrossPlatformTempPath) -and (Test-Path (Get-CrossPlatformTempPath))) {
            Remove-Item -Recurse -Force (Get-CrossPlatformTempPath) -ErrorAction SilentlyContinue
        }
        $script:CrossPlatformTempPath = $script:origTemp
    }
    }
}





